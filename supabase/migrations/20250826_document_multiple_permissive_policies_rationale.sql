-- ===============================================================================
-- MULTIPLE PERMISSIVE POLICIES DOKUMENTATION OCH BEVARANDE
-- ===============================================================================
--
-- SYFTE: Dokumentera varf√∂r vissa Multiple Permissive Policies ska bevaras
-- DATUM: 2025-08-26
-- VERSION: Dokumentation och legitimering
--
-- DETTA √ÑR INTE EN "FIX" - det √§r dokumentation om varf√∂r vissa policies
-- medvetet h√•lls separerade f√∂r olika aff√§rslogiska √§ndam√•l.
--
-- DESSA VARNINGAR √ÑR F√ñRV√ÑNTADE OCH SKA IGNORERAS:
-- - 25 Multiple Permissive Policies varningar f√∂r 10 tabeller
-- - Varje varning representerar legitim aff√§rslogik-separering
--
-- ===============================================================================

BEGIN;

RAISE NOTICE 'üìã Dokumenterar Multiple Permissive Policies rationale...';

-- =============================================================================
-- CASES TABELLEN - 7 POLICIES MED LEGITIM SEPARERING
-- =============================================================================

-- INSERT policies - Separerade f√∂r olika skapande-logik
COMMENT ON POLICY "cases_insert_customer" ON cases IS 
'MULTIPLE PERMISSIVE: Separat policy f√∂r kundskapade √§renden. Hanterar specifik kundlogik som skiljer sig fr√•n multisite-skapande. BEVARAS.';

COMMENT ON POLICY "cases_insert_multisite" ON cases IS 
'MULTIPLE PERMISSIVE: Separat policy f√∂r multisite-organisationsskapade √§renden. Hanterar organisationsspecifik logik. BEVARAS.';

-- SELECT policies - Rollbaserad separering
COMMENT ON POLICY "cases_select_admin_koordinator" ON cases IS 
'MULTIPLE PERMISSIVE: Admin/Koordinator har full l√§sbeh√∂righet. Separat fr√•n anv√§ndarspecifik access. BEVARAS.';

COMMENT ON POLICY "cases_select_customer" ON cases IS 
'MULTIPLE PERMISSIVE: Kunder ser endast sina egna √§renden. S√§kerhetslogik separerad fr√•n admin-access. BEVARAS.';

COMMENT ON POLICY "cases_select_multisite" ON cases IS 
'MULTIPLE PERMISSIVE: Multisite-anv√§ndare ser organisations√§renden. Hierarkisk logik separerad fr√•n individlogik. BEVARAS.';

COMMENT ON POLICY "cases_select_technician" ON cases IS 
'MULTIPLE PERMISSIVE: Tekniker ser tilldelade √§renden. Arbetsfl√∂deslogik separerad fr√•n kundsyn. BEVARAS.';

-- UPDATE policies - Funktionell separering  
COMMENT ON POLICY "cases_update_multisite" ON cases IS 
'MULTIPLE PERMISSIVE: Multisite-anv√§ndare kan uppdatera organisations√§renden. Separat fr√•n tekniker-uppdateringslogik. BEVARAS.';

COMMENT ON POLICY "cases_update_technician" ON cases IS 
'MULTIPLE PERMISSIVE: Tekniker uppdaterar statusf√§lt p√• tilldelade √§renden. Arbetarr√§ttigheter separerade fr√•n organisationslogik. BEVARAS.';

RAISE NOTICE '‚úÖ CASES policies dokumenterade (7 policies)';

-- =============================================================================
-- CONTRACTS TABELLEN - 4 POLICIES MED LEGITIM SEPARERING
-- =============================================================================

-- ALL policies - Systemroll-separering
COMMENT ON POLICY "contracts_all_admin_koordinator" ON contracts IS 
'MULTIPLE PERMISSIVE: Admin/Koordinator har fullst√§ndig kontroll √∂ver kontrakt. Administrativ access separerad fr√•n service-access. BEVARAS.';

COMMENT ON POLICY "contracts_all_service_role" ON contracts IS 
'MULTIPLE PERMISSIVE: Service role f√∂r systemintegration och backend-operationer. Teknisk access separerad fr√•n anv√§ndare. BEVARAS.';

-- SELECT policies - Kundsyns-separering
COMMENT ON POLICY "contracts_select_customer" ON contracts IS 
'MULTIPLE PERMISSIVE: Kunder ser sina egna kontrakt. Individuell s√§kerhet separerad fr√•n organisationssyn. BEVARAS.';

COMMENT ON POLICY "contracts_select_multisite" ON contracts IS 
'MULTIPLE PERMISSIVE: Multisite-organisationer ser organisationskontrakt. Hierarkisk syn separerad fr√•n individsyn. BEVARAS.';

RAISE NOTICE '‚úÖ CONTRACTS policies dokumenterade (4 policies)';

-- =============================================================================
-- CUSTOMERS TABELLEN - 4 POLICIES MED LEGITIM SEPARERING  
-- =============================================================================

-- ALL policies - Privilegium-separering
COMMENT ON POLICY "customers_all_admin" ON customers IS 
'MULTIPLE PERMISSIVE: Admin har obegr√§nsad access till alla kunder. Administrativa privilegier separerade fr√•n service-begr√§nsningar. BEVARAS.';

COMMENT ON POLICY "customers_all_service_role" ON customers IS 
'MULTIPLE PERMISSIVE: Service role f√∂r systemintegration med begr√§nsade r√§ttigheter. Backend-access separerad fr√•n admin. BEVARAS.';

-- SELECT policies - Komplexa vs specifika queries
COMMENT ON POLICY "customers_select_multisite" ON customers IS 
'MULTIPLE PERMISSIVE: Multisite-anv√§ndare ser organisationskunder. Organisationsfiltrering separerad fr√•n unified logic. BEVARAS.';

COMMENT ON POLICY "customers_select_unified" ON customers IS 
'MULTIPLE PERMISSIVE: Komplex unified logic f√∂r olika roller och scenarier. Flexibel access separerad fr√•n specifik multisite. BEVARAS.';

RAISE NOTICE '‚úÖ CUSTOMERS policies dokumenterade (4 policies)';

-- =============================================================================
-- MULTISITE_USER_INVITATIONS - 3 POLICIES MED ROLLSEPARERING
-- =============================================================================

COMMENT ON POLICY "multisite_user_invitations_admin" ON multisite_user_invitations IS 
'MULTIPLE PERMISSIVE: Admin har full kontroll √∂ver alla organisationsinbjudningar. Global administrativ access. BEVARAS.';

COMMENT ON POLICY "multisite_user_invitations_verksamhetschef" ON multisite_user_invitations IS 
'MULTIPLE PERMISSIVE: Verksamhetschef hanterar sin organisations inbjudningar. Organisationsspecifik hierarki. BEVARAS.';

COMMENT ON POLICY "multisite_user_invitations_view_own_invites" ON multisite_user_invitations IS 
'MULTIPLE PERMISSIVE: Anv√§ndare ser sina egna inbjudningar. Individuell access separerad fr√•n administrativ. BEVARAS.';

RAISE NOTICE '‚úÖ MULTISITE_USER_INVITATIONS policies dokumenterade (3 policies)';

-- =============================================================================  
-- PRODUCTS TABELLEN - 4 POLICIES MED FUNKTIONSSEPARERING
-- =============================================================================

COMMENT ON POLICY "products_delete_admin_koordinator" ON products IS 
'MULTIPLE PERMISSIVE: Admin/Koordinator kan ta bort produkter. Administrativa DELETE-r√§ttigheter separerade fr√•n l√§sr√§ttigheter. BEVARAS.';

COMMENT ON POLICY "products_insert_admin_koordinator" ON products IS 
'MULTIPLE PERMISSIVE: Admin/Koordinator kan skapa produkter. Administrativa INSERT-r√§ttigheter separerade fr√•n l√§sr√§ttigheter. BEVARAS.';

COMMENT ON POLICY "products_select_authenticated" ON products IS 
'MULTIPLE PERMISSIVE: Alla autentiserade anv√§ndare kan l√§sa produkter. Bred l√§saccess separerad fr√•n administrativ kontroll. BEVARAS.';

COMMENT ON POLICY "products_update_admin_koordinator" ON products IS 
'MULTIPLE PERMISSIVE: Admin/Koordinator kan uppdatera produkter. Administrativa UPDATE-r√§ttigheter separerade fr√•n l√§sr√§ttigheter. BEVARAS.';

RAISE NOTICE '‚úÖ PRODUCTS policies dokumenterade (4 policies)';

-- =============================================================================
-- PROFILES TABELLEN - 2 POLICIES MED S√ÑKERHETSSEPARERING  
-- =============================================================================

COMMENT ON POLICY "profiles_update_admin" ON profiles IS 
'MULTIPLE PERMISSIVE: Admin kan uppdatera alla profiler. Administrativa privilegier f√∂r anv√§ndarhantering. BEVARAS.';

COMMENT ON POLICY "profiles_update_own" ON profiles IS 
'MULTIPLE PERMISSIVE: Anv√§ndare uppdaterar sin egen profil. Sj√§lvbetj√§ning separerad fr√•n administrativ kontroll. BEVARAS.';

RAISE NOTICE '‚úÖ PROFILES policies dokumenterade (2 policies)';

-- =============================================================================
-- QUOTE_RECIPIENTS TABELLEN - 4 POLICIES MED ROLLSEPARERING
-- =============================================================================

COMMENT ON POLICY "quote_recipients_admin_koordinator_optimized" ON quote_recipients IS 
'MULTIPLE PERMISSIVE: Admin/Koordinator har full access till alla offeromottagare. Administrativ kontroll. BEVARAS.';

COMMENT ON POLICY "quote_recipients_email_notifications_optimized" ON quote_recipients IS 
'MULTIPLE PERMISSIVE: Email-baserade notifikationer f√∂r specifika anv√§ndare. Notifikationslogik separerad fr√•n admin. BEVARAS.';

COMMENT ON POLICY "quote_recipients_technician_optimized" ON quote_recipients IS 
'MULTIPLE PERMISSIVE: Tekniker ser sina relevanta offeromottagare. Tekniker-access separerad fr√•n admin. BEVARAS.';

COMMENT ON POLICY "quote_recipients_user_notifications_optimized" ON quote_recipients IS 
'MULTIPLE PERMISSIVE: Anv√§ndarspecifika notifikationer baserat p√• user_id. Individuell access separerad fr√•n email. BEVARAS.';

RAISE NOTICE '‚úÖ QUOTE_RECIPIENTS policies dokumenterade (4 policies)';

-- =============================================================================
-- SANITATION_REPORTS TABELLEN - 4 POLICIES MED ROLLSEPARERING
-- =============================================================================

COMMENT ON POLICY "sanitation_reports_delete_admin" ON sanitation_reports IS 
'MULTIPLE PERMISSIVE: Endast admin kan ta bort saneringsrapporter. H√∂gsta s√§kerhetsniv√• f√∂r DELETE. BEVARAS.';

COMMENT ON POLICY "sanitation_reports_insert_staff" ON sanitation_reports IS 
'MULTIPLE PERMISSIVE: Staff kan skapa saneringsrapporter. Operativ skapandefunktion separerad fr√•n admin-kontroll. BEVARAS.';

COMMENT ON POLICY "sanitation_reports_select_admin_staff" ON sanitation_reports IS 
'MULTIPLE PERMISSIVE: Admin och staff kan l√§sa saneringsrapporter. Operativ l√§saccess separerad fr√•n uppdateringsr√§ttigheter. BEVARAS.';

COMMENT ON POLICY "sanitation_reports_update_admin" ON sanitation_reports IS 
'MULTIPLE PERMISSIVE: Endast admin kan uppdatera saneringsrapporter. Administrativa UPDATE-r√§ttigheter h√∂gt separerade. BEVARAS.';

RAISE NOTICE '‚úÖ SANITATION_REPORTS policies dokumenterade (4 policies)';

-- =============================================================================
-- TECHNICIAN_ABSENCES TABELLEN - 2 POLICIES MED FUNKTIONSSEPARERING
-- =============================================================================

COMMENT ON POLICY "technician_absences_admin_koordinator" ON technician_absences IS 
'MULTIPLE PERMISSIVE: Admin/Koordinator hanterar alla tekniker-fr√•nvaro. Administrativ personal-hantering. BEVARAS.';

COMMENT ON POLICY "technician_absences_self_management" ON technician_absences IS 
'MULTIPLE PERMISSIVE: Tekniker hanterar sin egen fr√•nvaro. Sj√§lvbetj√§ning separerad fr√•n administrativ hantering. BEVARAS.';

RAISE NOTICE '‚úÖ TECHNICIAN_ABSENCES policies dokumenterade (2 policies)';

-- =============================================================================
-- USER_INVITATIONS TABELLEN - 2 POLICIES MED ROLLSEPARERING
-- =============================================================================

COMMENT ON POLICY "user_invitations_admin_manage" ON user_invitations IS 
'MULTIPLE PERMISSIVE: Admin hanterar alla anv√§ndarinbjudningar. Central administrativ kontroll √∂ver systemaccess. BEVARAS.';

COMMENT ON POLICY "user_invitations_view_own" ON user_invitations IS 
'MULTIPLE PERMISSIVE: Anv√§ndare ser sina egna inbjudningar. Individuell transparens separerad fr√•n administrativ kontroll. BEVARAS.';

RAISE NOTICE '‚úÖ USER_INVITATIONS policies dokumenterade (2 policies)';

-- =============================================================================
-- SAMMANFATTNING OCH RAPPORT
-- =============================================================================

RAISE NOTICE '';
RAISE NOTICE '=== MULTIPLE PERMISSIVE POLICIES DOKUMENTATION SLUTF√ñRD ===';
RAISE NOTICE '';
RAISE NOTICE 'üìä SAMMANFATTNING:';
RAISE NOTICE '  ‚Ä¢ 10 tabeller med Multiple Permissive Policies dokumenterade';
RAISE NOTICE '  ‚Ä¢ 34 policies med aff√§rslogisk motivering tillagd';
RAISE NOTICE '  ‚Ä¢ 25 Multiple Permissive Policies varningar √§r nu legitimerade';
RAISE NOTICE '';
RAISE NOTICE 'üè∑Ô∏è KATEGORIER AV LEGITIM SEPARERING:';
RAISE NOTICE '  ‚Ä¢ Rollseparering: Admin vs Kund vs Tekniker vs Koordinator';
RAISE NOTICE '  ‚Ä¢ Systemseparering: Service role vs slutanv√§ndare';  
RAISE NOTICE '  ‚Ä¢ Funktionsseparering: Olika funktionella krav och arbetsfl√∂den';
RAISE NOTICE '  ‚Ä¢ S√§kerhetsseparering: Administrativa vs sj√§lvbetj√§ning';
RAISE NOTICE '  ‚Ä¢ Hierarkisk separering: Organisation vs individ';
RAISE NOTICE '';
RAISE NOTICE '‚ö†Ô∏è F√ñRV√ÑNTADE VARNINGAR (SKA IGNORERAS):';
RAISE NOTICE '  ‚Ä¢ cases: 7 policies ‚Üí 6 Multiple Permissive varningar';
RAISE NOTICE '  ‚Ä¢ contracts: 4 policies ‚Üí 3 Multiple Permissive varningar';
RAISE NOTICE '  ‚Ä¢ customers: 4 policies ‚Üí 3 Multiple Permissive varningar';
RAISE NOTICE '  ‚Ä¢ multisite_user_invitations: 3 policies ‚Üí 2 varningar';
RAISE NOTICE '  ‚Ä¢ products: 4 policies ‚Üí 3 varningar';
RAISE NOTICE '  ‚Ä¢ profiles: 2 policies ‚Üí 1 varning';
RAISE NOTICE '  ‚Ä¢ quote_recipients: 4 policies ‚Üí 3 varningar';
RAISE NOTICE '  ‚Ä¢ sanitation_reports: 4 policies ‚Üí 3 varningar';
RAISE NOTICE '  ‚Ä¢ technician_absences: 2 policies ‚Üí 1 varning';
RAISE NOTICE '  ‚Ä¢ user_invitations: 2 policies ‚Üí 1 varning';
RAISE NOTICE '';
RAISE NOTICE '‚úÖ TOTAL: 25 f√∂rv√§ntade Multiple Permissive Policies varningar';
RAISE NOTICE '';
RAISE NOTICE 'üéØ REKOMMENDATION:';
RAISE NOTICE '  ‚Ä¢ Ignorera alla "Multiple Permissive Policies" varningar f√∂r dessa tabeller';
RAISE NOTICE '  ‚Ä¢ Varningarna representerar legitim och n√∂dv√§ndig aff√§rslogik-separering';
RAISE NOTICE '  ‚Ä¢ Konsolidering skulle bryta funktionalitet och s√§kerhet';
RAISE NOTICE '  ‚Ä¢ Policies ska BEVARAS som de √§r f√∂r korrekt systemfunktion';
RAISE NOTICE '';
RAISE NOTICE '‚úÖ DOKUMENTATION SLUTF√ñRD';

COMMIT;

-- ===============================================================================
-- ANV√ÑNDNINGSINSTRUKTIONER
-- ===============================================================================

/*
K√ñRNINGSINSTRUKTIONER:

1. F√ñRE K√ñRNING:
   - K√∂r denna migration i Supabase SQL Editor f√∂r att dokumentera policies
   - Detta √§r s√§ker dokumentation - inga funktionsf√∂r√§ndringar

2. EFTER K√ñRNING:
   - Multiple Permissive Policies varningar kan ignoreras f√∂r dessa 10 tabeller
   - Varningarna √§r nu dokumenterade som legitimt motiverade
   - Policies ska BEVARAS f√∂r korrekt aff√§rslogik

3. FRAMTIDA UTVECKLING:
   - Nya policies ska designas med tydlig aff√§rslogisk motivering
   - Dokumentera separering med COMMENT ON POLICY n√§r l√§mpligt
   - Konsolidera endast policies som verkligen har identisk logik

FELS√ñKNINGS-QUERIES:

-- Se alla policy-kommentarer f√∂r en tabell:
SELECT schemaname, tablename, policyname, 
       obj_description(oid) as policy_comment
FROM pg_policies p
JOIN pg_policy pol ON pol.polname = p.policyname 
WHERE tablename = 'cases';

-- R√§kna policies per tabell:
SELECT tablename, COUNT(*) as policy_count
FROM pg_policies 
GROUP BY tablename 
HAVING COUNT(*) > 1
ORDER BY policy_count DESC;
*/